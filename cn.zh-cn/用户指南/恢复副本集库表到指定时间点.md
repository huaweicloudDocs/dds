# 恢复副本集库表到指定时间点<a name="dds_03_0069"></a>

## 操作场景<a name="section1944553611563"></a>

为了保证数据的完整性，以及降低对原实例的性能影响，在进行库表级时间点恢复备份时，首先将选中时间点的全量数据和增量数据在后台恢复至一个临时实例，然后自动导出用户需要恢复的库表，再将这些库表恢复至原实例。由于需要对实例的所有数据进行备份及恢复操作，对于数据量较大的实例，所需时间较长，请耐心等待。

通过库表级时间点恢复数据，会在实例上新生成恢复后的库表，不会导致实例数据被覆盖，您可以根据需要恢复库表。

## 恢复须知<a name="section194851615132319"></a>

-   恢复成功后，默认会在实例上生成以“原表名\_bak\_时间戳”命名的新表，如果有索引，索引的ns会相应的变成“原库名.原表名\_bak\_时间戳”，请您根据实际情况对表进行重命名或者后续的数据处理。
-   由于会在原实例上生成恢复后的新库表，请您确保原实例磁盘空间充足。
-   “库名.表名”长度小于等于120字符，“库名.表名.索引名”长度小于等于128字符，请您确保恢复后的库表名和索引名长度符合要求，避免恢复失败。
-   请您确保恢复后的表名和已有表名不同，避免恢复失败。
-   选择表级恢复，如果对应时间不存在该表，则系统会创建一个空表，选择库级恢复，则不会创建该表。

## 使用限制<a name="section246265955612"></a>

目前，仅DDS社区版3.2和3.4版本的副本集实例支持库表级时间点恢复。

开启自动备份策略后，才允许按时间点恢复库表数据。

## 操作步骤<a name="section12850635183113"></a>

1.  [登录文档数据库服务](https://support.huaweicloud.com/qs-dds/dds_02_0043.html)。
2.  在“实例管理“页面，选择副本集实例，单击实例名称。
3.  在左侧导航树，单击“备份恢复“。
4.  在“备份恢复“页面，单击“库表级时间点恢复“。
5.  在弹出框中，填选相关信息。

    **表 1**  库表信息

    <a name="table47493287484"></a>
    <table><thead align="left"><tr id="row1774962894810"><th class="cellrowborder" valign="top" width="28.249999999999996%" id="mcps1.2.3.1.1"><p id="p8750132815484"><a name="p8750132815484"></a><a name="p8750132815484"></a>配置项</p>
    </th>
    <th class="cellrowborder" valign="top" width="71.75%" id="mcps1.2.3.1.2"><p id="p975072815483"><a name="p975072815483"></a><a name="p975072815483"></a>说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row10750192854812"><td class="cellrowborder" valign="top" width="28.249999999999996%" headers="mcps1.2.3.1.1 "><p id="p1075012884810"><a name="p1075012884810"></a><a name="p1075012884810"></a>恢复日期</p>
    </td>
    <td class="cellrowborder" valign="top" width="71.75%" headers="mcps1.2.3.1.2 "><p id="p37501728134810"><a name="p37501728134810"></a><a name="p37501728134810"></a>实例自动备份所在的日期。</p>
    </td>
    </tr>
    <tr id="row475092844819"><td class="cellrowborder" valign="top" width="28.249999999999996%" headers="mcps1.2.3.1.1 "><p id="p20750122854813"><a name="p20750122854813"></a><a name="p20750122854813"></a>可恢复的时间区间</p>
    </td>
    <td class="cellrowborder" valign="top" width="71.75%" headers="mcps1.2.3.1.2 "><p id="p575082824815"><a name="p575082824815"></a><a name="p575082824815"></a>指定自动备份日期下，可恢复的时间区间。</p>
    </td>
    </tr>
    <tr id="row1575052864811"><td class="cellrowborder" valign="top" width="28.249999999999996%" headers="mcps1.2.3.1.1 "><p id="p675022810484"><a name="p675022810484"></a><a name="p675022810484"></a>基准时间点</p>
    </td>
    <td class="cellrowborder" valign="top" width="71.75%" headers="mcps1.2.3.1.2 "><p id="p975010288489"><a name="p975010288489"></a><a name="p975010288489"></a>指定可恢复的时间区间下，自动全量备份的时间点。</p>
    </td>
    </tr>
    <tr id="row147503281488"><td class="cellrowborder" valign="top" width="28.249999999999996%" headers="mcps1.2.3.1.1 "><p id="p20750182814481"><a name="p20750182814481"></a><a name="p20750182814481"></a>基准可恢复的时间区间</p>
    </td>
    <td class="cellrowborder" valign="top" width="71.75%" headers="mcps1.2.3.1.2 "><p id="p12750828124814"><a name="p12750828124814"></a><a name="p12750828124814"></a>基于该自动全量备份，能够将库表恢复到的时间区域。</p>
    </td>
    </tr>
    <tr id="row5750142816482"><td class="cellrowborder" valign="top" width="28.249999999999996%" headers="mcps1.2.3.1.1 "><p id="p17502282489"><a name="p17502282489"></a><a name="p17502282489"></a>选择恢复库表</p>
    </td>
    <td class="cellrowborder" valign="top" width="71.75%" headers="mcps1.2.3.1.2 "><p id="p022118914442"><a name="p022118914442"></a><a name="p022118914442"></a>在左侧库表区域，显示查询到的基于基准时间点的自动全量备份下的库表。勾选左侧库表名，库表信息将同步到右侧区域。</p>
    </td>
    </tr>
    <tr id="row10359123412437"><td class="cellrowborder" valign="top" width="28.249999999999996%" headers="mcps1.2.3.1.1 "><p id="p2360133412434"><a name="p2360133412434"></a><a name="p2360133412434"></a>要恢复到的时间点</p>
    </td>
    <td class="cellrowborder" valign="top" width="71.75%" headers="mcps1.2.3.1.2 "><p id="p174641252134319"><a name="p174641252134319"></a><a name="p174641252134319"></a>指定基准可恢复的时间区间下的某一时间点。</p>
    </td>
    </tr>
    <tr id="row392211311514"><td class="cellrowborder" valign="top" width="28.249999999999996%" headers="mcps1.2.3.1.1 "><p id="p19231631145113"><a name="p19231631145113"></a><a name="p19231631145113"></a>自定义库表</p>
    </td>
    <td class="cellrowborder" valign="top" width="71.75%" headers="mcps1.2.3.1.2 "><p id="p1834734195517"><a name="p1834734195517"></a><a name="p1834734195517"></a>您可以根据需要添加自定义库表。</p>
    <a name="ul15864112512361"></a><a name="ul15864112512361"></a><ul id="ul15864112512361"><li>由于系统库不可进行恢复，库名不能为系统库admin和local。</li><li>库名不能包含特殊字符".\/$和空格。</li><li>表名不能包含特殊字符“$”，不能以“system.”作为前缀。</li><li>“库名.表名”长度小于等于120字符，“库名.表名.索引名”长度小于等于128字符，请您确保恢复后的库表名和索引名长度符合要求，避免恢复失败。</li><li>请您确保恢复后的表名和已有表名不同，避免恢复失败。</li><li>恢复成功后，默认会在实例上生成以“原表名_bak_时间戳”命名的新表，如果有索引，索引的ns会相应的变成“原库名.原表名_bak_时间戳”，请您根据实际情况对表进行重命名或者后续的数据处理。</li></ul>
    <p id="p101473955210"><a name="p101473955210"></a><a name="p101473955210"></a>对于已添加的自定义库表，建议您将该类库表对应的恢复到时间点，区别于同步到右侧的库表对应的恢复到时间点，设置为不同时间值。系统将按时间点恢复库表数据到该自定义库表。</p>
    </td>
    </tr>
    <tr id="row149591738191711"><td class="cellrowborder" valign="top" width="28.249999999999996%" headers="mcps1.2.3.1.1 "><p id="p3928643161710"><a name="p3928643161710"></a><a name="p3928643161710"></a>恢复类型</p>
    </td>
    <td class="cellrowborder" valign="top" width="71.75%" headers="mcps1.2.3.1.2 "><p id="p2928144314176"><a name="p2928144314176"></a><a name="p2928144314176"></a>选择将数据恢复到库或恢复到表。</p>
    <p id="p10330121542"><a name="p10330121542"></a><a name="p10330121542"></a>选择表级恢复，如果对应时间不存在该表，则系统会创建一个空表，选择库级恢复，数据将单独恢复到库，不会创建该表。</p>
    </td>
    </tr>
    </tbody>
    </table>

    单击“确定“，开始恢复库表数据。恢复后的新库表数据与所选要恢复到时间点下库表数据一致。

    **图 1**  选择恢复库表<a name="fig640421944818"></a>  
    ![](figures/选择恢复库表.png "选择恢复库表")

6.  在“实例管理“页面，可查看该实例状态为“恢复中“，恢复过程中该实例业务不中断。
7.  恢复成功后，您可根据实际情况对库表进行处理。

    如果您的业务需要继续使用原先的库表名，可以通过**rename**操作，备份原库表，并将您的业务切换到恢复后的库表。确保业务正常后，再删除原库表。

    重命名单个库表示例：

    **db.adminCommand\(\{renameCollection: "db1.test1", to: "db2.test2"\}\)**

    该命令表示将db1库下的表test1移动到db2下，并重命名为test2。


